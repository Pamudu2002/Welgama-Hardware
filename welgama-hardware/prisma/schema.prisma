generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  username      String         @unique
  password      String
  role          String
  createdAt     DateTime       @default(now())
  activityLogs  ActivityLog[]
  inventoryLogs InventoryLog[]
  sales         Sale[]
  expenses      Expense[]
}

model Category {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  products Product[]
}

model Product {
  id                Int            @id @default(autoincrement())
  name              String
  categoryId        Int
  costPrice         Decimal        @db.Decimal(10, 2)
  sellingPrice      Decimal        @db.Decimal(10, 2)
  quantity          Int            @default(0)
  unit              String
  lowStockThreshold Int            @default(5)
  inventoryLogs     InventoryLog[]
  category          Category       @relation(fields: [categoryId], references: [id])
  saleItems         SaleItem[]
}

model InventoryLog {
  id             Int      @id @default(autoincrement())
  productId      Int
  quantityChange Int
  quantityBefore Int
  quantityAfter  Int
  reason         String
  changedAt      DateTime @default(now())
  userId         Int?
  product        Product  @relation(fields: [productId], references: [id])
  user           User?    @relation(fields: [userId], references: [id])
}

model Customer {
  id       Int       @id @default(autoincrement())
  name     String
  phone    String?
  address  String?
  balance  Decimal   @default(0.0) @db.Decimal(10, 2)
  payments Payment[]
  sales    Sale[]
}

model Sale {
  id            Int        @id @default(autoincrement())
  userId        Int
  customerId    Int?
  date          DateTime   @default(now())
  totalAmount   Decimal    @db.Decimal(10, 2)
  paymentStatus String
  amountPaid    Decimal    @default(0.0) @db.Decimal(10, 2)
  changeGiven   Decimal    @default(0.0) @db.Decimal(10, 2)
  isDelivered   Boolean    @default(true)
  orderStatus   String     @default("completed")
  payments      Payment[]
  customer      Customer?  @relation(fields: [customerId], references: [id])
  user          User       @relation(fields: [userId], references: [id])
  items         SaleItem[]
}

model SaleItem {
  id            Int     @id @default(autoincrement())
  saleId        Int
  productId     Int
  quantity      Int
  priceSnapshot Decimal @db.Decimal(10, 2)
  subtotal      Decimal @db.Decimal(10, 2)
  discount      Decimal @default(0.0) @db.Decimal(10, 2)
  discountType  String  @default("amount")
  product       Product @relation(fields: [productId], references: [id])
  sale          Sale    @relation(fields: [saleId], references: [id])
}

model Payment {
  id         Int      @id @default(autoincrement())
  saleId     Int?
  customerId Int
  date       DateTime @default(now())
  amount     Decimal  @db.Decimal(10, 2)
  note       String?
  customer   Customer @relation(fields: [customerId], references: [id])
  sale       Sale?    @relation(fields: [saleId], references: [id])
}

model Draft {
  id         Int      @id @default(autoincrement())
  userId     Int
  customerId Int?
  items      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int?
  action      String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
}

model Expense {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  reason    String
  amount    Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@index([createdAt])
}
